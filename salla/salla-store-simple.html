<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mukhawara Store - Simple Presentation</title>
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: Arial, sans-serif;
        }
        
        .hero {
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 60px 0;
            text-align: center;
            margin-bottom: 40px;
        }
        
        .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .stats-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 10px;
            min-width: 150px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .product-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .product-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .product-price {
            font-size: 1.5rem;
            color: #e74c3c;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .product-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .btn-add-cart {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .btn-add-cart:hover {
            background: #1a252f;
        }
        
        .btn-view {
            background: transparent;
            color: #2c3e50;
            border: 2px solid #2c3e50;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-view:hover {
            background: #2c3e50;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
        }
        
        .error {
            background: #dc3545;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }
        
        .badge {
            background: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8rem;
        }
        
        .rating {
            color: #f39c12;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <div class="hero">
        <div class="container">
            <h1>Mukhawara Store</h1>
            <p>Premium Cotton Fabrics & Textiles</p>
        </div>
    </div>

    <div class="container">
        <!-- Stats Section -->
        <div class="stats-container" id="statsContainer">
            <div class="stat-box">
                <div class="stat-number" id="totalProducts">-</div>
                <div class="stat-label">Total Products</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="avgPrice">-</div>
                <div class="stat-label">Average Price</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="totalViews">-</div>
                <div class="stat-label">Total Views</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="availableProducts">-</div>
                <div class="stat-label">Available Now</div>
            </div>
        </div>

        <!-- Loading Message -->
        <div class="loading" id="loadingMessage">
            <h3>Loading products from Mukhawara store...</h3>
            <p>Please wait while we fetch your products</p>
        </div>

        <!-- Products Container -->
        <div id="productsContainer"></div>
        
        <!-- Error Message (hidden by default) -->
        <div class="error" id="errorMessage" style="display: none;"></div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p>&copy; 2024 Mukhawara Store. All rights reserved.</p>
        </div>
    </footer>

    <!-- Salla SDK -->
    <script src="https://cdn.salla.network/js/twilight/latest/twilight.js"></script>
    <script>
        let allProducts = [];

        // Initialize when page loads
        window.addEventListener('load', function() {
            console.log('Page loaded, initializing Salla SDK...');
            initializeStore();
        });

        function initializeStore() {
            if (typeof salla !== 'undefined') {
                console.log('Salla SDK found, initializing...');
                try {
                    salla.init({
                        debug: true,
                        language_code: 'ar',
                        store: {
                            id: 229278595,
                            url: "https://mukhaura.salla.sa"
                        }
                    });
                    
                    console.log('Salla SDK initialized successfully');
                    
                    // Wait a moment then load products
                    setTimeout(loadProducts, 1000);
                    
                } catch (error) {
                    console.error('SDK initialization error:', error);
                    showError('Failed to initialize store connection: ' + error.message);
                }
            } else {
                console.error('Salla SDK not loaded');
                showError('Salla SDK not available. Please check your internet connection.');
                
                // Retry after 2 seconds
                setTimeout(initializeStore, 2000);
            }
        }

        function loadProducts() {
            console.log('Loading products...');
            
            if (typeof salla === 'undefined' || !salla.product) {
                showError('Product API not available');
                return;
            }
            
            try {
                const queryParams = {
                    source: 'latest',
                    limit: 10
                };
                
                salla.product.fetch(queryParams).then(function(response) {
                    console.log('Products loaded:', response);
                    
                    allProducts = response.data || [];
                    
                    if (allProducts.length > 0) {
                        displayProducts(allProducts);
                        updateStats(allProducts);
                        hideLoading();
                    } else {
                        showError('No products found in your store');
                    }
                    
                }).catch(function(error) {
                    console.error('Error loading products:', error);
                    showError('Failed to load products: ' + error.message);
                });
                
            } catch (error) {
                console.error('Error in loadProducts:', error);
                showError('Error loading products: ' + error.message);
            }
        }

        function displayProducts(products) {
            const container = document.getElementById('productsContainer');
            
            if (products.length === 0) {
                container.innerHTML = '<div class="error">No products to display</div>';
                return;
            }
            
            container.innerHTML = products.map(function(product) {
                return createProductHTML(product);
            }).join('');
        }

        function createProductHTML(product) {
            var price = (product.price && product.price.amount) ? product.price.amount : 0;
            var currency = (product.price && product.price.currency) ? product.price.currency : 'SAR';
            var views = product.views || 0;
            var sold = product.sold_quantity || 0;
            var rating = (product.rating && product.rating.rate) ? product.rating.rate : 0;
            var reviews = (product.rating && product.rating.count) ? product.rating.count : 0;
            var imageUrl = product.main_image || 'https://picsum.photos/seed/' + product.id + '/400/300.jpg';
            var isAvailable = product.is_available !== false;
            var hasSale = product.has_special_price === true;
            
            return '<div class="product-card">' +
                '<img src="' + imageUrl + '" alt="' + (product.name || 'Product') + '" class="product-image" onerror="this.src=\'https://picsum.photos/seed/fallback/400/300.jpg\'">' +
                '<div class="product-title">' + (product.name || 'Unnamed Product') + '</div>' +
                '<div class="rating">' +
                    generateStars(rating) + ' ' + rating + ' (' + reviews + ' reviews)' +
                '</div>' +
                '<div class="product-price">' + price + ' ' + currency + '</div>' +
                '<div class="product-meta">' +
                    '<span><i class="fas fa-eye"></i> ' + formatNumber(views) + ' views</span>' +
                    '<span><i class="fas fa-shopping-cart"></i> ' + sold + ' sold</span>' +
                '</div>' +
                '<p>' + (product.description ? product.description.substring(0, 100) + '...' : 'Premium quality cotton fabric from Mukhawara store.') + '</p>' +
                '<div>' +
                    '<button class="btn-add-cart" onclick="addToCart(' + product.id + ')" ' + (isAvailable ? '' : 'disabled') + '>' + 
                        (isAvailable ? 'Add to Cart' : 'Out of Stock') + 
                    '</button>' +
                    '<a href="' + (product.url || '#') + '" target="_blank" class="btn-view">View Details</a>' +
                    (hasSale ? '<span class="badge">SALE</span>' : '') +
                    (!isAvailable ? '<span class="badge">OUT OF STOCK</span>' : '') +
                '</div>' +
            '</div>';
        }

        function generateStars(rating) {
            var fullStars = Math.floor(rating);
            var halfStar = (rating % 1 >= 0.5) ? 1 : 0;
            var emptyStars = 5 - fullStars - halfStar;
            
            var stars = '';
            for (var i = 0; i < fullStars; i++) {
                stars += '★';
            }
            if (halfStar) {
                stars += '☆';
            }
            for (var i = 0; i < emptyStars; i++) {
                stars += '☆';
            }
            return stars;
        }

        function updateStats(products) {
            var totalProducts = products.length;
            var availableProducts = products.filter(function(p) { return p.is_available !== false; }).length;
            var totalViews = products.reduce(function(sum, p) { return sum + (parseInt(p.views) || 0); }, 0);
            var avgPrice = products.reduce(function(sum, p) { return sum + ((p.price && p.price.amount) ? p.price.amount : 0); }, 0) / totalProducts;
            
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('availableProducts').textContent = availableProducts;
            document.getElementById('totalViews').textContent = formatNumber(totalViews);
            document.getElementById('avgPrice').textContent = avgPrice.toFixed(0) + ' SAR';
        }

        function addToCart(productId) {
            if (typeof salla !== 'undefined' && salla.cart) {
                try {
                    var cartItem = {
                        id: productId,
                        quantity: 1
                    };
                    
                    salla.cart.addItem(cartItem).then(function(response) {
                        alert('Product added to cart successfully!');
                        console.log('Added to cart:', response);
                    }).catch(function(error) {
                        alert('Failed to add to cart: ' + error.message);
                        console.error('Cart error:', error);
                    });
                    
                } catch (error) {
                    alert('Error adding to cart: ' + error.message);
                }
            } else {
                alert('Cart functionality not available');
            }
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function showError(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loadingMessage').style.display = 'none';
        }

        // Also try loading products after 3 seconds as backup
        setTimeout(function() {
            if (allProducts.length === 0) {
                console.log('Backup product loading attempt...');
                loadProducts();
            }
        }, 3000);
    </script>
</body>
</html>
